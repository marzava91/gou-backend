/* =========================
   5) PEDIDOS
========================= */
model Order {
  id       String @id @default(cuid())
  tenantId String
  storeId  String

  channel OrderChannel

  customerUserId String?
  posSessionId   String?

  status        OrderStatus   @default(DRAFT)
  paymentStatus PaymentStatus @default(UNPAID)
  deliveryType  DeliveryType

  currency String  @default("PEN")
  subtotal Decimal @db.Decimal(12, 2) @default(0)
  discountTotal Decimal @db.Decimal(12, 2) @default(0)
  taxTotal Decimal @db.Decimal(12, 2) @default(0)
  shippingTotal Decimal @db.Decimal(12, 2) @default(0)
  total Decimal @db.Decimal(12, 2) @default(0)

  createdBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  store  Store  @relation(fields: [storeId], references: [id], onDelete: Restrict)

  customerUser User? @relation("UserOrders", fields: [customerUserId], references: [id], onDelete: SetNull)

  items   OrderItem[]
  posSale PosSale?

  @@index([tenantId, storeId])
  @@index([tenantId, storeId, status])
  @@index([tenantId, storeId, paymentStatus])
  @@index([customerUserId])
  @@index([posSessionId])
  @@index([channel])
}

model OrderItem {
  id       String @id @default(cuid())
  tenantId String
  storeId  String
  orderId  String
  productId String

  nameSnapshot String
  skuSnapshot  String?
  sellUnitSnapshot SellUnit

  qty Int

  unitPriceSnapshot Decimal @db.Decimal(12, 2)
  priceListIdSnapshot String?
  priceTierIdSnapshot String?

  discountSnapshot Decimal @db.Decimal(12, 2) @default(0)
  lineTotal Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  store  Store  @relation(fields: [storeId], references: [id], onDelete: Restrict)

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  allocations StockAllocation[]

  @@index([tenantId, storeId])
  @@index([orderId])
  @@index([productId])
}
