/* =========================
   4) INVENTARIOS
========================= */
model StockItem {
  id       String @id @default(cuid())
  tenantId String
  storeId  String
  productId String

  onHand   Int @default(0)
  reserved Int @default(0)

  reorderPoint Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  store   Store   @relation(fields: [storeId], references: [id], onDelete: Restrict)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@unique([tenantId, storeId, productId])
  @@index([tenantId, storeId])
  @@index([productId])
}

model PurchaseOrder {
  id       String @id @default(cuid())
  tenantId String
  storeId  String
  supplierId String?

  status     PurchaseOrderStatus @default(DRAFT)
  expectedAt DateTime?
  notes      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  store  Store  @relation(fields: [storeId], references: [id], onDelete: Restrict)

  batches           PurchaseBatch[]
  purchaseOrderItems PurchaseOrderItem[]

  @@index([tenantId, storeId])
  @@index([tenantId, storeId, status])
  @@index([supplierId])
}

model PurchaseOrderItem {
  id            String @id @default(cuid())
  purchaseOrderId String
  productId     String
  qtyOrdered    Int
  expectedUnitCost Decimal? @db.Decimal(12, 2)

  createdAt DateTime @default(now())

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([purchaseOrderId])
  @@index([productId])
}

model PurchaseBatch {
  id            String @id @default(cuid())
  tenantId      String
  storeId       String
  purchaseOrderId String?

  receivedAt DateTime @default(now())
  status     PurchaseBatchStatus @default(RECEIVED)
  notes      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  store  Store  @relation(fields: [storeId], references: [id], onDelete: Restrict)

  purchaseOrder PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  items         BatchItem[]

  @@index([tenantId, storeId])
  @@index([purchaseOrderId])
}

model BatchItem {
  id            String @id @default(cuid())
  tenantId      String
  storeId       String
  purchaseBatchId String
  productId     String

  qtyReceived  Int
  qtyRemaining Int
  unitCost     Decimal? @db.Decimal(12, 2)
  expiresAt    DateTime?

  createdAt DateTime @default(now())

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  store        Store        @relation(fields: [storeId], references: [id], onDelete: Restrict)
  purchaseBatch PurchaseBatch @relation(fields: [purchaseBatchId], references: [id], onDelete: Cascade)
  product      Product      @relation(fields: [productId], references: [id], onDelete: Restrict)

  allocations StockAllocation[]
  movements   StockMovement[]

  @@index([tenantId, storeId])
  @@index([purchaseBatchId])
  @@index([productId])
}

model StockMovement {
  id       String @id @default(cuid())
  tenantId String
  storeId  String
  productId String

  type    StockMovementType
  qtyDelta Int
  reason  String?

  refType String?
  refId   String?

  batchItemId String?

  createdAt DateTime @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  store   Store   @relation(fields: [storeId], references: [id], onDelete: Restrict)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  batchItem BatchItem? @relation(fields: [batchItemId], references: [id], onDelete: SetNull)

  @@index([tenantId, storeId])
  @@index([productId])
  @@index([type])
  @@index([refType, refId])
  @@index([batchItemId])
}

model StockAllocation {
  id       String @id @default(cuid())
  tenantId String
  storeId  String

  refType String
  refId   String

  orderItemId String?
  batchItemId String
  qtyAllocated Int
  unitCostSnapshot Decimal? @db.Decimal(12, 2)

  createdAt DateTime @default(now())

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  store    Store    @relation(fields: [storeId], references: [id], onDelete: Restrict)
  batchItem BatchItem @relation(fields: [batchItemId], references: [id], onDelete: Restrict)
  orderItem OrderItem? @relation(fields: [orderItemId], references: [id], onDelete: SetNull)

  @@index([tenantId, storeId])
  @@index([refType, refId])
  @@index([batchItemId])
  @@index([orderItemId])
}