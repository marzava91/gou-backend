/* =========================
   6) POS
========================= */
model PosSession {
  id       String @id @default(cuid())
  tenantId String
  storeId  String

  openedByUserId String
  openedAt DateTime @default(now())
  openingCashAmount Decimal @db.Decimal(12, 2) @default(0)

  status  PosSessionStatus @default(OPEN)

  closedAt DateTime?
  closedByUserId String?

  closingCashAmount Decimal? @db.Decimal(12, 2)
  expectedCashAmount Decimal? @db.Decimal(12, 2)
  cashDiffAmount Decimal? @db.Decimal(12, 2)

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Restrict)

  openedBy User @relation("PosSessionOpenedBy", fields: [openedByUserId], references: [id], onDelete: Restrict)
  closedBy User? @relation("PosSessionClosedBy", fields: [closedByUserId], references: [id], onDelete: SetNull)

  sales PosSale[]

  @@index([tenantId, storeId])
  @@index([tenantId, storeId, status])
  @@index([openedByUserId])
  @@index([closedByUserId])
}

model PosSale {
  id       String @id @default(cuid())
  tenantId String
  storeId  String
  posSessionId String

  cashierUserId String

  orderId String? @unique

  status PosSaleStatus @default(COMPLETED)

  subtotalSnapshot Decimal @db.Decimal(12, 2) @default(0)
  discountTotalSnapshot Decimal @db.Decimal(12, 2) @default(0)
  taxTotalSnapshot Decimal @db.Decimal(12, 2) @default(0)
  totalSnapshot Decimal @db.Decimal(12, 2) @default(0)
  currency String @default("PEN")

  createdAt DateTime @default(now())

  voidedAt DateTime?
  voidReason String?

  tenant  Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Restrict)
  session PosSession @relation(fields: [posSessionId], references: [id], onDelete: Restrict)

  cashier User @relation("PosSaleCashier", fields: [cashierUserId], references: [id], onDelete: Restrict)

  order Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  payments PosPayment[]

  @@index([tenantId, storeId])
  @@index([posSessionId])
  @@index([cashierUserId])
  @@index([status])
}

model PosPayment {
  id       String @id @default(cuid())
  tenantId String
  storeId  String
  posSaleId String

  method PosPaymentMethod
  amount  Decimal @db.Decimal(12, 2)
  currency String @default("PEN")
  reference String?

  paidAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  store  Store  @relation(fields: [storeId], references: [id], onDelete: Restrict)
  sale   PosSale @relation(fields: [posSaleId], references: [id], onDelete: Cascade)

  @@index([tenantId, storeId])
  @@index([posSaleId])
  @@index([method])
}