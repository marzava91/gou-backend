/* =========================
   3) CAT√ÅLOGO DE PRODUCTOS
========================= */
model Brand {
  id       String @id @default(cuid())
  tenantId String

  name String
  code String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  products Product[]

  @@unique([tenantId, name])
  @@unique([tenantId, code])
  @@index([tenantId])
}

model Category {
  id       String @id @default(cuid())
  tenantId String
  storeId  String

  name      String
  slug      String
  slugPath  String
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  parentId String?
  parent   Category? @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryHierarchy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation("TenantCategories", fields: [tenantId], references: [id], onDelete: Restrict)
  store  Store  @relation("StoreCategories", fields: [storeId], references: [id], onDelete: Restrict)

  products ProductCategory[]

  @@unique([tenantId, storeId, slugPath])
  @@index([tenantId, storeId])
  @@index([tenantId, storeId, parentId])
}

model Product {
  id       String @id @default(cuid())
  tenantId String
  storeId  String

  sku     String
  barcode String?
  name    String

  description String?
  imageUrl     String?

  brandId String?
  status  ProductStatus @default(ACTIVE)

  sellUnit    SellUnit @default(UNIT)
  isWeighable Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  store  Store  @relation(fields: [storeId], references: [id], onDelete: Restrict)
  brand  Brand? @relation(fields: [brandId], references: [id], onDelete: SetNull)

  categories ProductCategory[]
  prices     ProductPrice[]

  // Inventario
  stockItems     StockItem[]
  purchaseItems  PurchaseOrderItem[]
  batchItems     BatchItem[]
  stockMovements StockMovement[]

  // Pedidos
  orderItems OrderItem[]

  @@unique([tenantId, storeId, sku])
  @@unique([tenantId, storeId, barcode])
  @@index([tenantId, storeId])
  @@index([tenantId, storeId, status])
  @@index([tenantId, storeId, brandId])
  @@index([tenantId, storeId, name])
}

model ProductCategory {
  productId  String
  categoryId String
  createdAt  DateTime @default(now())

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId])
  @@index([categoryId])
}

model PriceList {
  id       String @id @default(cuid())
  tenantId String
  storeId  String

  code     PriceListCode
  name     String
  channel  SalesChannel?
  priority Int     @default(0)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  store  Store  @relation(fields: [storeId], references: [id], onDelete: Restrict)

  prices ProductPrice[]

  @@unique([tenantId, storeId, code])
  @@index([tenantId])
  @@index([tenantId, storeId])
  @@index([tenantId, isActive])
  @@index([tenantId, storeId, priority])
}

model ProductPrice {
  id         String @id @default(cuid())
  tenantId   String
  storeId    String
  productId  String
  priceListId String

  currency    String  @default("PEN")
  unitPrice   Decimal @db.Decimal(12, 2)
  taxIncluded Boolean @default(true)

  validFrom DateTime?
  validTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  store     Store     @relation(fields: [storeId], references: [id], onDelete: Restrict)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  priceList PriceList @relation(fields: [priceListId], references: [id], onDelete: Restrict)

  tiers ProductPriceTier[]

  @@unique([tenantId, storeId, productId, priceListId])
  @@index([tenantId, storeId])
  @@index([productId])
  @@index([priceListId])
}

model ProductPriceTier {
  id            String @id @default(cuid())
  productPriceId String
  minQty        Int
  unitPrice     Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())

  productPrice ProductPrice @relation(fields: [productPriceId], references: [id], onDelete: Cascade)

  @@unique([productPriceId, minQty])
  @@index([productPriceId])
}
